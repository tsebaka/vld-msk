<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>3D Земля и Самолёт</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    /* Простые стили для полного экрана */
    body {
      margin: 0;
      overflow: hidden;
      background-color: #f5f5dc;
    }
    #scene-container {
      width: 100vw;
      height: 100vh;
      display: block;
    }
  </style>
</head>
<body>
  <div id="scene-container"></div>

  <!-- Подключаем Three.js и OrbitControls через CDN -->
  <script src="https://unpkg.com/three@0.149.0/build/three.min.js"></script>
  <script src="https://unpkg.com/three@0.149.0/examples/js/controls/OrbitControls.js"></script>

  <script>
    // Создаем сцену, камеру и рендерер
    const scene = new THREE.Scene();
    const camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 0.1, 1000);
    camera.position.set(0, 0, 3);

    const renderer = new THREE.WebGLRenderer({ antialias: true });
    renderer.setSize(window.innerWidth, window.innerHeight);
    document.getElementById('scene-container').appendChild(renderer.domElement);

    // Добавляем OrbitControls для управления камерой
    const controls = new THREE.OrbitControls(camera, renderer.domElement);
    controls.enableDamping = true;

    // Добавляем базовое освещение
    const ambientLight = new THREE.AmbientLight(0xffffff, 0.5);
    scene.add(ambientLight);
    const directionalLight = new THREE.DirectionalLight(0xffffff, 1);
    directionalLight.position.set(5, 3, 5);
    scene.add(directionalLight);

    // Загружаем текстуру Земли (надёжный URL)
    const textureLoader = new THREE.TextureLoader();
    const earthTexture = textureLoader.load(
      'https://threejsfundamentals.org/threejs/resources/images/earth-day.jpg',
      () => { console.log("Текстура Земли загружена"); },
      undefined,
      (err) => { console.error("Ошибка загрузки текстуры:", err); }
    );

    // Создаем сферу Земли
    const earthGeometry = new THREE.SphereGeometry(1, 64, 64);
    const earthMaterial = new THREE.MeshStandardMaterial({ map: earthTexture });
    const earth = new THREE.Mesh(earthGeometry, earthMaterial);
    scene.add(earth);

    // Функция для перевода геокоординат (широта, долгота) в 3D-координаты на сфере
    function latLongToVector3(lat, lon, radius) {
      const phi = (90 - lat) * (Math.PI / 180);
      const theta = (lon + 180) * (Math.PI / 180);
      const x = -radius * Math.sin(phi) * Math.cos(theta);
      const z = radius * Math.sin(phi) * Math.sin(theta);
      const y = radius * Math.cos(phi);
      return new THREE.Vector3(x, y, z);
    }

    // Определяем координаты городов
    const moscow = { lat: 55.7558, lon: 37.6173 };
    const vladikavkaz = { lat: 43.0245, lon: 44.6906 };

    // Создаем маркеры городов (небольшие шары)
    const markerGeometry = new THREE.SphereGeometry(0.02, 8, 8);
    const moscowMaterial = new THREE.MeshBasicMaterial({ color: 0xff0000 });
    const vladMaterial = new THREE.MeshBasicMaterial({ color: 0x0000ff });

    const moscowMarker = new THREE.Mesh(markerGeometry, moscowMaterial);
    moscowMarker.position.copy(latLongToVector3(moscow.lat, moscow.lon, 1.01));
    earth.add(moscowMarker);

    const vladMarker = new THREE.Mesh(markerGeometry, vladMaterial);
    vladMarker.position.copy(latLongToVector3(vladikavkaz.lat, vladikavkaz.lon, 1.01));
    earth.add(vladMarker);

    // Создаем "самолётик" в виде конуса
    const planeGeometry = new THREE.ConeGeometry(0.02, 0.06, 8);
    const planeMaterial = new THREE.MeshBasicMaterial({ color: 0x333333 });
    const airplane = new THREE.Mesh(planeGeometry, planeMaterial);
    // Поворачиваем конус, чтобы он "смотрел" вперёд
    airplane.rotation.x = Math.PI;
    earth.add(airplane);

    // Задаем параметры анимации для самолёта
    airplane.userData = {
      from: moscowMarker.position.clone(),
      to: vladMarker.position.clone(),
      progress: 0,
      goingForward: true
    };

    // Функция анимации самолёта
    function moveAirplane(delta) {
      const data = airplane.userData;
      if (data.goingForward) {
        data.progress += 0.4 * delta;
        if (data.progress >= 1) {
          data.progress = 1;
          data.goingForward = false;
        }
      } else {
        data.progress -= 0.4 * delta;
        if (data.progress <= 0) {
          data.progress = 0;
          data.goingForward = true;
        }
      }
      const newPos = new THREE.Vector3().lerpVectors(data.from, data.to, data.progress);
      airplane.position.copy(newPos);
      let direction = new THREE.Vector3().subVectors(data.to, data.from).normalize();
      if (!data.goingForward) direction.negate();
      airplane.lookAt(airplane.position.clone().add(direction));
    }

    // Главный цикл анимации
    const clock = new THREE.Clock();
    function animate() {
      requestAnimationFrame(animate);
      const delta = clock.getDelta();
      controls.update();

      // Автоматическое вращение Земли
      earth.rotation.y += 0.001;

      // Обновляем движение самолёта
      moveAirplane(delta);

      renderer.render(scene, camera);
    }
    animate();

    // Обработка изменения размеров окна
    window.addEventListener('resize', () => {
      camera.aspect = window.innerWidth / window.innerHeight;
      camera.updateProjectionMatrix();
      renderer.setSize(window.innerWidth, window.innerHeight);
    });
  </script>
</body>
</html>
